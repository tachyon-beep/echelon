# Terrain Generation v2 Architecture

**Status:** Implemented  
**Date:** 2025-12-22  
**Implementation:** `echelon/gen/`

## Overview

The v2 generation system replaces monolithic "archetype" functions with a structured, modular pipeline designed to produce tactically interesting, deterministic, and highly varied maps.

It strictly separates **Layout** (macro structure), **Biomes** (local content), and **Safety** (connectivity/fightability).

## The Pipeline

The generation process is invoked via `VoxelWorld.generate(config, rng)`, which delegates to `echelon.gen.layout.generate_layout`.

### 1. Initialization
- Creates an empty `VoxelWorld` of the specified size (default 100x100x20).
- Ensures a ground layer exists.

### 2. Quadrant Split (Jittered)
- The map is divided into four quadrants (TL, TR, BL, BR).
- The split point is **jittered** randomly (Â±10% of map size) to prevent a perfectly artificial crosshair look.
- **Why?** Forces asymmetry while guaranteeing 4 distinct zones.

### 3. Biome Assignment
- 4 Biomes are selected from the **Biome Catalog** (`echelon.gen.biomes`).
- Biomes are assigned to quadrants via a random permutation.
- **Why?** Prevents "Red team always starts in the Forest" bias. Every corner can be any biome.

### 4. Biome Filling (The Brush Pass)
- Each quadrant is filled using its assigned **Biome Brush**.
- Brushes are localized generators that respect the bounds of their quadrant.
- **Current Biomes:**
    - `urban_residential`: Dense courtyard blocks, alley grids.
    - `industrial_refinery`: Pipe corridors, tank clusters, thin walls.
    - `civic_government`: Large monolithic structures, plazas, low walls.
    - `forest_park`: Scattered tree columns, rock outcrops.
    - `barrens`: Open terrain with sparse rock cover.

### 5. Skeleton Carving (The Safety Pass)
- *Note: This step happens in `EchelonEnv` immediately after generation.*
- `echelon.gen.corridors.carve_macro_corridors` cuts guaranteed playable lanes through the noise generated by biomes.
- **Features:**
    - **Objective Ring:** A clear fighting ring around the capture zone.
    - **Team Lanes:** Guaranteed paths from spawns to the center.
    - **Flank Routes:** Secondary off-angle paths.
- **Why?** Biomes generate "noise" (cover). The Skeleton generates "signal" (movement).

### 6. Validation & Fixups (The Guarantee)
- `echelon.gen.validator.ConnectivityValidator` runs a weighted A* search.
- If a spawn is disconnected from the objective, it **digs** a tunnel/path through the obstruction.
- All fixups are recorded in `world.meta["fixups"]` for debugging.

## Data Structures

### The Recipe (`world.meta`)
Every map includes a detailed recipe allowing perfect reconstruction and debugging.

```json
{
  "generator": "layout_v2",
  "biome_layout": {
    "TL": "urban_residential",
    "TR": "forest_park",
    "BL": "industrial_refinery",
    "BR": "civic_government"
  },
  "transform": "flip_x",
  "spawn_corners": {"blue": "TL", "red": "BR"},
  "fixups": ["blue_lane:dig=2"]
}
```

## Adding Content

### How to add a new Biome
1. Open `echelon/gen/biomes.py`.
2. Define a function `fill_my_biome(world, min_x, min_y, max_x, max_y, rng)`.
3. Use `world.set_box_solid(...)` to place voxels.
4. Register it in the `CATALOG` dictionary.

### How to add a new Layout Template
1. Open `echelon/gen/layout.py`.
2. Implement a new function (e.g., `generate_diagonal_layout`).
3. Wire it into the main entry point or config switch.
